flowchart TB
    subgraph Client
        WebApp[Web Application]
    end

    subgraph Backend
        API[API Express]
        Cache[(Redis Queue)]
        DB[(PostgreSQL)]
    end

    subgraph IoT
        MQTT[MQTT Broker]
        Controller[Controllore]
        Sprinkler1[Irrigatore 1]
        Sprinkler2[Irrigatore 2]
    end

    %% Flusso comandi
    WebApp -->|HTTP| API
    API -->|Salva| DB
    API -->|Se offline| Cache
    API -->|Se online| MQTT
    Cache -->|Quando torna online| MQTT
    MQTT -->|Comandi| Controller
    Controller -->|Controllo| Sprinkler1
    Controller -->|Controllo| Sprinkler2

    %% Flusso stato
    Controller -->|Status MQTT| MQTT
    MQTT -->|Status| API
    API -->|Aggiorna| DB
    DB -->|Polling 10s| WebApp

    classDef client fill:#e1f5fe,stroke:#01579b
    classDef backend fill:#f3e5f5,stroke:#4a148c
    classDef iot fill:#e8f5e9,stroke:#1b5e20
    
    class WebApp client
    class API,Cache,DB backend
    class MQTT,Controller,Sprinkler1,Sprinkler2 iot
